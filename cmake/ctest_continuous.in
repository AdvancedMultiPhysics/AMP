# Sample script to run ctest and submit the results
SET ( CTEST_PROJECT_NAME "AMP" )
SET ( CTEST_SOURCE_DIRECTORY "../../../AMP/src" )
SET ( CTEST_BINARY_DIRECTORY "." )
SET ( CTEST_CMAKE_COMMAND "./lap0086227_cmake" )

SET ( CTEST_BUILD_NAME "AMP-Continuous" )
SET ( CTEST_TEST_TIMEOUT 300 )
SET ( CTEST_CUSTOM_MAXIMUM_NUMBER_OF_ERRORS 500 )
SET ( CTEST_CUSTOM_MAXIMUM_NUMBER_OF_WARNINGS 500 )
SET ( CTEST_CUSTOM_MAXIMUM_PASSED_TEST_OUTPUT_SIZE "10000" )
SET ( CTEST_CUSTOM_MAXIMUM_FAILED_TEST_OUTPUT_SIZE "20000" )
SET ( NIGHTLY_START_TIME "18:00:00 EST" )
SET ( CTEST_NIGHTLY_START_TIME "22:00:00 EST" )
SET ( COVERAGE_COMMAND /usr/bin/gcov )

SET ( CTEST_COMMAND "\"${CTEST_EXECUTABLE_NAME}\" -D ${CTEST_DASHBOARD}" )
SET ( CTEST_CONFIGURE_COMMAND ${CTEST_CMAKE_COMMAND} )
SET ( CTEST_BUILD_COMMAND "make build-test -i -j4" )
SET ( CTEST_COVERAGE_COMMAND ${COVERAGE_COMMAND} )

# Clear the binary directory and create an initial cache6
CTEST_EMPTY_BINARY_DIRECTORY (${CTEST_BINARY_DIRECTORY})
FILE(WRITE "${CTEST_BINARY_DIRECTORY}/CMakeCache.txt" "CTEST_TEST_CTEST:BOOL=1")
SITE_NAME( CTEST_SITE )



# ****Testing Process****

MESSAGE("Continuous Build Starting")

SET(OLDREV -1)
SET(NEWREV -1)
SET(CTEST_UPDATE_COMMAND hg)
SET(CTEST_UPDATE_OPTIONS "-q")
WHILE( ${CTEST_ELAPSED_TIME} LESS 64800 )

    SET(START_TIME ${CTEST_ELAPSED_TIME})    
    CTEST_START(Continuous)

    # Build only if new revision of source is available
    WHILE( ${OLDREV} STREQUAL ${NEWREV} )
        MESSAGE("Checking for updates...")
        EXECUTE_PROCESS(COMMAND hg pull -q WORKING_DIRECTORY ${CTEST_SOURCE_DIRECTORY})
        CTEST_UPDATE(BUILD "${CTEST_SOURCE_DIRECTORY}")
        EXECUTE_PROCESS(COMMAND hg id -i WORKING_DIRECTORY ${CTEST_SOURCE_DIRECTORY} OUTPUT_VARIABLE NEWREV)
        STRING(REGEX REPLACE "(\r?\n)+$" "" NEWREV "${NEWREV}")
        IF( ${OLDREV} STREQUAL ${NEWREV} )
            MESSAGE("Source not updated, no need to build source")
            CTEST_SLEEP(6)
        ENDIF()
    ENDWHILE()
    MESSAGE("Old revision: ${OLDREV}")
    MESSAGE("New revision: ${NEWREV}\n")
    SET( OLDREV ${NEWREV} )

    # Configure and run the tests
    #CTEST_CONFIGURE( BUILD "${CTEST_BUILD_DIRECTORY}" )
    #CTEST_BUILD( BUILD "${CTEST_BUILD_DIRECTORY}" APPEND )
    #CTEST_TEST( EXCLUDE test   PARALLEL_LEVEL 1 )

    # Submit the results to billmp1
    SET ( CTEST_DROP_METHOD "http" )
    SET ( CTEST_DROP_SITE "billmp1.ornl.gov" )
    SET ( CTEST_DROP_LOCATION "/CDash/submit.php?project=AMP" )
    SET ( CTEST_DROP_SITE_CDASH TRUE )
    SET ( DROP_SITE_CDASH TRUE )
    #CTEST_SUBMIT()

    # Submit the results to oblivion
    SET ( CTEST_DROP_METHOD "http" )
    SET ( CTEST_DROP_SITE "oblivion.engr.colostate.edu" )
    SET ( CTEST_DROP_LOCATION "/CDash/submit.php?project=AMP" )
    SET ( CTEST_DROP_SITE_CDASH TRUE )
    SET ( CTEST_DROP_SITE_CDASH TRUE )
    #CTEST_SUBMIT()

ENDWHILE()
MESSAGE("FATAL_ERROR")





