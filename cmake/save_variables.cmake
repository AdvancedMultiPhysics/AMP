# Save the necessary cmake variables to a file for applications to load
# Note: we need to save the external libraries in the same order as AMP for consistency
FUNCTION( SAVE_CMAKE_FLAGS FILENAME )
    # Don't force downstream apps from using certain warnings
    STRING(REGEX REPLACE "-Wextra" "" CMAKE_C_FLAGS_2   "${CMAKE_C_FLAGS}"   )
    STRING(REGEX REPLACE "-Wextra" "" CMAKE_CXX_FLAGS_2 "${CMAKE_CXX_FLAGS}" )
    # Write the header (comments)
    FILE(WRITE  "${FILENAME}" "# This is a automatically generate file to include AMP within another application\n" )
    FILE(APPEND "${FILENAME}" "MESSAGE( WARNING \"amp.cmake is deprecated.  Please update build system to use FIND_PACKAGE( AMP )\" )\n\n" )
    # Write the compilers and compile flags
    FILE(APPEND "${FILENAME}" "# Set the compilers and compile flags\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_BUILD_TYPE ${CMAKE_BUILD_TYPE})\n" )
    IF ( NOT USING_MSVC )
        FILE(APPEND "${FILENAME}" "SET(CMAKE_C_COMPILER_ARG1 \"${CMAKE_C_COMPILER_ARG1}\")\n" )
        FILE(APPEND "${FILENAME}" "SET(CMAKE_CXX_COMPILER_ARG1 \"${CMAKE_CXX_COMPILER_ARG1}\")\n" )
        FILE(APPEND "${FILENAME}" "SET(CMAKE_Fortran_COMPILER_ARG1 \"${CMAKE_Fortran_COMPILER_ARG1}\")\n" )
        FILE(APPEND "${FILENAME}" "SET(CMAKE_C_COMPILER \"${CMAKE_C_COMPILER}\")\n" )
        FILE(APPEND "${FILENAME}" "SET(CMAKE_CXX_COMPILER \"${CMAKE_CXX_COMPILER}\")\n" )
        FILE(APPEND "${FILENAME}" "SET(CMAKE_Fortran_COMPILER \"${CMAKE_Fortran_COMPILER}\")\n" )
        FILE(APPEND "${FILENAME}" "SET(USE_FORTRAN ${USE_FORTRAN})\n" )
    ENDIF()
    FILE(APPEND "${FILENAME}" "SET(CMAKE_C_FLAGS \"${CMAKE_C_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_Fortran_FLAGS \"${CMAKE_Fortran_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_C_FLAGS_DEBUG \"${CMAKE_C_FLAGS_DEBUG}\" CACHE STRING \"Debug flags\" FORCE)\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_C_FLAGS_RELEASE \"${CMAKE_C_FLAGS_RELEASE}\" CACHE STRING \"Release flags\" FORCE)\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_CXX_FLAGS_DEBUG \"${CMAKE_CXX_FLAGS_DEBUG}\" CACHE STRING \"Debug flags\" FORCE)\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_CXX_FLAGS_RELEASE \"${CMAKE_CXX_FLAGS_RELEASE}\" CACHE STRING \"Release flags\" FORCE)\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_Fortran_FLAGS_DEBUG \"${CMAKE_Fortran_FLAGS_DEBUG}\" CACHE STRING \"Debug flags\" FORCE)\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_Fortran_FLAGS_RELEASE \"${CMAKE_Fortran_FLAGS_RELEASE}\" CACHE STRING \"Release flags\" FORCE)\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_CXX_STANDARDS ${CMAKE_CXX_STANDARD})\n" )
    FILE(APPEND "${FILENAME}" "SET(CXX_STD ${CXX_STD})\n" )
    FILE(APPEND "${FILENAME}" "SET(CXX_STD_FLAG ${CXX_STD_FLAG})\n" )
    FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS(-DCXX_STD=${CXX_STD})\n" )
    FILE(APPEND "${FILENAME}" "SET(LDFLAGS \"${LDFLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_EXE_LINK_DYNAMIC_C_FLAGS \"${CMAKE_EXE_LINK_DYNAMIC_C_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_EXE_LINK_DYNAMIC_CXX_FLAGS \"${CMAKE_EXE_LINK_DYNAMIC_CXX_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_SHARED_LIBRARY_C_FLAGS \"${CMAKE_SHARED_LIBRARY_C_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_SHARED_LIBRARY_CXX_FLAGS \"${CMAKE_SHARED_LIBRARY_CXX_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_EXE_LINKER_FLAGS \"${CMAKE_EXE_LINKER_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_SHARED_LINKER_FLAGS \"${CMAKE_SHARED_LINKER_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_SHARED_LIBRARY_LINK_C_FLAGS \"${CMAKE_SHARED_LIBRARY_LINK_C_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS \"${CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS}\")\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_INSTALL_RPATH_USE_LINK_PATH ${CMAKE_INSTALL_RPATH_USE_LINK_PATH})\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_INSTALL_RPATH ${CMAKE_INSTALL_RPATH})\n" )
    FILE(APPEND "${FILENAME}" "SET(CMAKE_BUILD_WITH_INSTALL_RPATH ${CMAKE_BUILD_WITH_INSTALL_RPATH})\n" )
    # Write the AMP_DATA and AMP_SOURCE paths
    FILE(APPEND "${FILENAME}" "# Set the AMP data and source directories\n" )
    FILE(APPEND "${FILENAME}" "SET(AMP_DATA ${AMP_DATA})\n" )
    FILE(APPEND "${FILENAME}" "SET(AMP_SOURCE ${AMP_SOURCE_DIR})\n" )
    # Create the AMP libraries and include paths
    FILE(APPEND "${FILENAME}" "# Set the AMP libraries\n" )
    IF ( AMP_LIB )
        FILE(APPEND "${FILENAME}" "SET(AMP_LIBS ${AMP_LIB})\n" )
    ELSE()
        FILE(APPEND "${FILENAME}" "SET(AMP_LIBS ${AMP_LIBS} ${AMP_LIBS})\n" )
    ENDIF()
    FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${AMP_TRUNK}/external/boost/include )\n" )
    FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${AMP_INSTALL_DIR}/include )\n" )
    IF ( USE_AMP_UTILS )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_UTILS ${USE_AMP_UTILS}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_UTILS ) \n" )
    ENDIF()
    IF ( USE_AMP_MESH )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_MESH ${USE_AMP_MESH}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_MESH ) \n" )
    ENDIF()
    IF ( USE_AMP_DISCRETIZATION )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_DISCRETIZATION ${USE_AMP_DISCRETIZATION}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_DISCRETIZATION ) \n" )
    ENDIF()
    IF ( USE_AMP_VECTORS )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_VECTORS ${USE_AMP_VECTORS}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_VECTORS ) \n" )
    ENDIF()
    IF ( USE_AMP_MATRICES )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_MATRICES ${USE_AMP_MATRICES}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_MATRICES ) \n" )
    ENDIF()
    IF ( USE_AMP_MATERIALS )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_MATERIALS ${USE_AMP_MATERIALS}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_MATERIALS ) \n" )
    ENDIF()
    IF ( USE_AMP_OPERATORS )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_OPERATORS ${USE_AMP_OPERATORS}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_OPERATORS ) \n" )
    ENDIF()
    IF ( USE_AMP_SOLVERS )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_SOLVERS ${USE_AMP_SOLVERS}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_SOLVERS ) \n" )
    ENDIF()
    IF ( USE_AMP_TIME_INTEGRATORS )
        FILE(APPEND "${FILENAME}" "SET(USE_AMP_TIME_INTEGRATORS ${USE_AMP_TIME_INTEGRATORS}) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_AMP_TIME_INTEGRATORS ) \n" )
    ENDIF()
    # Create the external libraries and include paths in the order they are linked in AMP
    FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS )\n" )
    # Add boost
    IF ( USE_EXT_BOOST )
        FILE(APPEND "${FILENAME}" "# Add boost\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${BOOST_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_BOOST 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_BOOST ) \n" )
    ENDIF()
    # Add Libmesh
    IF ( USE_EXT_LIBMESH )
        FILE(APPEND "${FILENAME}" "# Add Libmesh\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${LIBMESH_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${LIBMESH_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -DLIBMESH_ENABLE_PARMESH )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_LIBMESH 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_LIBMESH ) \n" )
    ENDIF()
    # Add NEK
    IF ( USE_EXT_NEK )
        FILE(APPEND "${FILENAME}" "# Add NEK\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${NEK_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${NEK_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_NEK 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_NEK ) \n" )
    ENDIF()
    # Add MOAB
    IF ( USE_EXT_MOAB )
        FILE(APPEND "${FILENAME}" "# Add MOAB\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${MOAB_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${MOAB_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_MOAB 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_MOAB ) \n" )
    ENDIF()
    # Add DENDRO
    IF ( USE_EXT_DENDRO )
        FILE(APPEND "${FILENAME}" "# Add DENDRO\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${DENDRO_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${DENDRO_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_DENDRO 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_DENDRO ) \n" )
    ENDIF()
    # Add Netcdf
    IF ( USE_NETCDF )
        FILE(APPEND "${FILENAME}" "# Add Netcdf\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${NETCDF_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${NETCDF_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_NETCDF 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_NETCDF ) \n" )
    ENDIF()
    # Add DTK 
    IF ( USE_EXT_DTK )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_DTK 1 ) \n" )
    ENDIF()
    # Add Trilinos
    IF ( USE_EXT_TRILINOS )
        FILE(APPEND "${FILENAME}" "# Add Trilinos\n" )
        IF (EXISTS "${TRILINOS_DIRECTORY}/lib/cmake/Trilinos/TrilinosConfig.cmake")
            FILE(APPEND "${FILENAME}" "INCLUDE(\"${TRILINOS_DIRECTORY}/lib/cmake/Trilinos/TrilinosConfig.cmake\")\n")
        ENDIF()
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${TRILINOS_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${TRILINOS_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_TRILINOS 1 ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_UTILS   ${USE_TRILINOS_UTILS}   ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_TEUCHOS ${USE_TRILINOS_TEUCHOS} ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_VECTORS ${USE_TRILINOS_VECTORS} ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_SOLVERS ${USE_TRILINOS_SOLVERS} ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_THYRA   ${USE_TRILINOS_THYRA}   ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_NOX     ${USE_TRILINOS_NOX}     ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_STKMESH ${USE_TRILINOS_STKMESH} ) \n" )
        FILE(APPEND "${FILENAME}" "SET( USE_TRILINOS_STRATIMIKOS ${USE_TRILINOS_STRATIMIKOS} ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_TRILINOS ) \n" )
        IF ( USE_TRILINOS_THYRA )
            FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_TRILINOS_THYRA ) \n" )
        ENDIF()
        IF ( USE_TRILINOS_NOX )
            FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_TRILINOS_NOX ) \n" )
        ENDIF()
        IF ( USE_TRILINOS_STKMESH )
            FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_TRILINOS_STKMESH ) \n" )
        ENDIF()
    ENDIF()
    # Add Eigen
    IF ( USE_EXT_EIGEN )
        FILE(APPEND "${FILENAME}" "# Add Eigen\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${EIGEN3_INCLUDE_DIR} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_EIGEN 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_EIGEN ) \n" )
    ENDIF()
    # Add PETsc
    IF ( USE_EXT_PETSC )
        FILE(APPEND "${FILENAME}" "# Add PETsc\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${PETSC_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${PETSC_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_PETSC 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_PETSC ) \n" )
    ENDIF()
    # Add Sundials
    IF ( USE_EXT_SUNDIALS )
        FILE(APPEND "${FILENAME}" "# Add Sundials\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${SUNDIALS_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${SUNDIALS_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_SUNDIALS 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_SUNDIALS ) \n" )
    ENDIF()
    # Add Silo
    IF ( USE_EXT_SILO )
        FILE(APPEND "${FILENAME}" "# Add silo\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${SILO_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${SILO_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_SILO 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_SILO ) \n" )
    ENDIF()
    # Add Hypre
    IF ( USE_EXT_HYPRE )
        FILE(APPEND "${FILENAME}" "# Add hypre\n" )
        # FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${HYPRE_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${HYPRE_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_HYPRE 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_HYPRE ) \n" )
    ENDIF()
    # Add X11
    IF ( USE_EXT_X11 )
        FILE(APPEND "${FILENAME}" "# Add X11\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${X11_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${X11_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_X11 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_X11 ) \n" )
    ENDIF()
    # Add HDF5
    IF ( USE_EXT_HDF5 )
        FILE(APPEND "${FILENAME}" "# Add HDF5\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${HDF5_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${HDF5_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_HDF5 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_HDF5 ) \n" )
    ENDIF()
    # Add TIMER
    IF ( USE_TIMER OR USE_EXT_TIMER )
        FILE(APPEND "${FILENAME}" "# Add Timer\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${TIMER_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${TIMER_LIBS} )\n" )
    ENDIF()
    # Add MPI
    IF ( USE_EXT_MPI )
        FILE(APPEND "${FILENAME}" "# Add MPI\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${MPI_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS}  ${MPI_LINK_FLAGS} ${MPI_LIBRARIES} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_MPI 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_MPI ) \n" )
        FILE(APPEND "${FILENAME}" "SET(MPIEXEC ${MPIEXEC} )\n" )
        FILE(APPEND "${FILENAME}" "SET(MPIEXEC_NUMPROC_FLAG ${MPIEXEC_NUMPROC_FLAG} )\n" )
        IF ( USE_MPI_FOR_SERIAL_TESTS )
            FILE(APPEND "${FILENAME}" "SET(USE_MPI_FOR_SERIAL_TESTS 1 )\n" )
            FILE(APPEND "${FILENAME}" "SET(USE_EXT_MPI_FOR_SERIAL_TESTS 1 )\n" )
        ENDIF()
    ENDIF()
    # Add ZLIB
    IF ( USE_EXT_ZLIB )
        FILE(APPEND "${FILENAME}" "# Add ZLIB\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${ZLIB_INCLUDE} )\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${ZLIB_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_ZLIB 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_EXT_ZLIB ) \n" )
    ENDIF()
    # Add LAPACK and BLAS
    FILE(APPEND "${FILENAME}" "# Add LAPACK/BLAS\n" )
    FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS}  ${LAPACK_LIBS} ${BLAS_LIBS} )\n" )
    FOREACH ( lib ${BLAS_LAPACK_LIBS} )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} \"${lib}\" )\n" )
    ENDFOREACH()
    # Add LDLIBS
    IF ( LDLIBS )
    	FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS}  ${LDLIBS} )\n" )
    ENDIF()
    # Add coverage
    IF ( ENABLE_GCOV )
        FILE(APPEND "${FILENAME}" "# Add coverage flags\n" )
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${COVERAGE_LIBS} )\n" )
        FILE(APPEND "${FILENAME}" "SET( ENABLE_GCOV 1 ) \n" )
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -fprofile-arcs -ftest-coverage ) \n" )
    ENDIF()
    # Add doxygen
    IF ( USE_EXT_DOXYGEN )
        FILE(APPEND "${FILENAME}" "# Add doxygen flags\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_EXT_DOXYGEN ${USE_EXT_DOXYGEN} )\n" )
        FILE(APPEND "${FILENAME}" "SET( DOXYGEN_MACROS \"${DOXYGEN_MACROS}\" )\n" )
    ENDIF()
    # Add CUDA
    IF(USE_CUDA)
        FILE(APPEND "${FILENAME}" "# Add CUDA\n" )
        FILE(APPEND "${FILENAME}" "SET( USE_CUDA ${USE_CUDA})\n")
        FILE(APPEND "${FILENAME}" "SET( CUDA_FIND_QUIETLY ${CUDA_FIND_QUIETLY} )\n")
        FILE(APPEND "${FILENAME}" "SET( CUDA_NVCC_FLAGS \"${CUDA_NVCC_FLAGS}\" )\n")
        FILE(APPEND "${FILENAME}" "SET( CUDA_PROPAGATE_HOST_FLAGS ${CUDA_PROPAGATE_HOST_FLAGS} )\n")
        FILE(APPEND "${FILENAME}" "SET( CUDA_TOOLKIT_ROOT_DIR \"${CUDA_TOOLKIT_ROOT_DIR}\" )\n")
        FILE(APPEND "${FILENAME}" "SET( CUDA_VERSION \"${CUDA_VERSION}\" )\n")
        FILE(APPEND "${FILENAME}" "SET( CUDA_LIBS \"${CUDA_LIBRARIES}\" )\n")
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES ( ${CUDA_INCLUDE_DIRS} )\n")
        FILE(APPEND "${FILENAME}" "ADD_DEFINITIONS( -D USE_CUDA )\n")
        FILE(APPEND "${FILENAME}" "INCLUDE_DIRECTORIES( ${CUDA_INCLUDE_DIRS} )\n")
        FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${CUDA_LIBRARIES} )\n" )
        FILE(APPEND "${FILENAME}" "INCLUDE( FindCUDA )\n")
    ENDIF()
    # Add misc flags
    FILE(APPEND "${FILENAME}" "# Add misc flags\n" )
    FILE(APPEND "${FILENAME}" "SET( EXTERNAL_LIBS $" "{EXTERNAL_LIBS} ${SYSTEM_LIBS} )\n" )
    FILE(APPEND "${FILENAME}" "SET( TEST_MAX_PROCS ${TEST_MAX_PROCS} )\n" )
    FILE(APPEND "${FILENAME}" "\n" )
ENDFUNCTION()

