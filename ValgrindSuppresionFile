# To run valgrind:
# valgrind --leak-check=yes --show-reachable=yes --track-origins=yes --suppressions=/projects/AMP/AMP/ValgrindSuppresionFile --log-file=memory.log ./test_AMPManager
# valgrind --leak-check=yes --show-reachable=yes --track-origins=yes --suppressions=/projects/AMP/AMP/ValgrindSuppresionFile --gen-suppressions=all --log-file=memory.log ./test_AMPManager
#
# For slightly better performance:
# valgrind --leak-check=yes --show-reachable=yes --suppressions=/projects/AMP/AMP/ValgrindSuppresionFile --log-file=memory.log ./test_AMPManager


#### Supress std::ios_base::sync_with_stdio memory errors
{
   std/ios_base/sync_with_stdio
   Memcheck:Leak
   ...
   obj:/usr/lib/libstdc++.so.6.0.13
   fun:_ZNSt8ios_base15sync_with_stdioEb
   ...
}


# Supress static_initialization_and_destruction
{
   static_initialization_and_destruction
   Memcheck:Leak
   match-leak-kinds: reachable
   ...
   fun:_Z41__static_initialization_and_destruction_0ii
   ...
}


# ACML supressions
{
   IdentifyCPUCond
   Memcheck:Cond
   ...
   fun:acmlcpuid2
   ...
}
{
   IdentifyCPUValue
   Memcheck:Value8
   ...
   fun:acmlcpuid_once
   fun:acmlcpuid2
   ...
}
{
   acmlfma3_cond
   Memcheck:Cond
   fun:acmlfma3_supported_
   ...
}
{
   acmlfma4_cond
   Memcheck:Cond
   fun:acmlfma4_supported_
   ...
}


# MPI supressions
{
   MPI_init_cond
   Memcheck:Cond
   ...
   fun:PMPI_Init
   ...
}
{
   MPI_init_value
   Memcheck:Value8
   ...
   fun:PMPI_Init
   ...
}
{
   MPI_init_addr16
   Memcheck:Addr16
   ...
   fun:PMPI_Init
   ...
}
{
   MPI_init_addr8
   Memcheck:Addr8
   ...
   fun:PMPI_Init
   ...
}
{
   MPI_init_addr4
   Memcheck:Addr4
   ...
   fun:PMPI_Init
   ...
}
{
   MPI_init_addr1
   Memcheck:Addr1
   ...
   fun:PMPI_Init
   ...
}
{
   gethostname_cond
   Memcheck:Cond
   ...
   fun:gethostbyname_r
   fun:gethostbyname
   ...
}
{
   gethostname_value
   Memcheck:Value8
   ...
   fun:gethostbyname_r
   fun:gethostbyname
   ...
}
{
   PMPI_Init_malloc_indirect
   Memcheck:Leak
   match-leak-kinds: indirect
   fun:malloc
   ...
   fun:PMPI_Init
   ...
}
{
   PMPI_Init_malloc_definite
   Memcheck:Leak
   match-leak-kinds: definite
   fun:malloc
   ...
   fun:PMPI_Init
   ...
}
{
   mpichInitThread
   Memcheck:Leak
   ...
   fun:PMPI_Init_thread
   fun:_ZN3AMP7AMP_MPI9start_MPIERiPPci
   ...
}
{
   orte_finalize
   Memcheck:Leak
   ...
   fun:orte_finalize
   fun:ompi_mpi_finalize
   ...
}
{
   clone_event
   Memcheck:Leak
   ...
   fun:event_base_loop
   ...
   fun:start_thread
   fun:clone
}
{
   pmix_ptl_base_send_handler
   Memcheck:Param
   writev(vector[1])
   ...
   fun:pmix_ptl_base_send_handler
   ...
}
{
   ompi_mpi_init
   Memcheck:Leak
   ...
   fun:ompi_mpi_init
   ...
}
{
   orte_init_leak
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_init
   ...
}
{
   orte_init_leak
   Memcheck:Leak
   fun:calloc
   ...
   fun:orte_init
   ...
}
{
   orte_daemon_recv
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_daemon_recv
   ...
}
{
   orte_rmaps_base_map_job
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_rmaps_base_map_job
   ...
}
{
   orte_plm_base_post_launch
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_plm_base_post_launch
   ...
}
{
   orte_debugger_init_after_spawnh
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_debugger_init_after_spawn
   ...
}
{
   orte_odls_base_default_launch_local
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_odls_base_default_launch_local
   ...
}
{
   orte_iof_base_write_output
   Memcheck:Leak
   fun:malloc
   ...
   fun:orte_iof_base_write_output
   ...
}
{
   orte_submit_init
   Memcheck:Leak
   ...
   fun:orte_submit_init
   ...
}
{
   orte_exit
   Memcheck:Leak
   ...
   fun:exit
   obj:/usr/bin/orterun
   ...
}


# Supress nvidia errors
{
   libnvidia-opencl
   Memcheck:Leak
   ...
   obj:/usr/lib/x86_64-linux-gnu/libnvidia-opencl.so.*
   ...
}


# hwloc
{
   hwloc_leak
   Memcheck:Leak
   ...
   obj:*/libhwloc.so*
}
{
   hwloc_topology_load_leak
   Memcheck:Leak
   ...
   fun:hwloc_topology_load
   ...
}
{
   hwloc_PMPI_Init_leak
   Memcheck:Leak
   obj:*/libhwloc.so*
   ...
   fun:PMPI_Init
   ...
}


# System errors
{
   map_doit_memory
   Memcheck:Cond
   fun:index
   fun:expand_dynamic_string_token
   fun:_dl_map_object
   fun:map_doit
   fun:_dl_catch_error
   ...
}
{
   expand_dynamic_string_token
   Memcheck:Cond
   fun:index
   fun:expand_dynamic_string_token
   ...
   fun:dl_main
   fun:_dl_sysdep_start
   fun:_dl_start
   ...
}
{
   call_init
   Memcheck:Leak
   match-leak-kinds: reachable
   ...
   fun:call_init
   fun:_dl_init
   ...
}
{
   dl_open_worker_definite
   Memcheck:Leak
   match-leak-kinds: definite
   ...
   fun:dl_open_worker
   ...
}
{
   dl_open_worker_indirect
   Memcheck:Leak
   match-leak-kinds: indirect
   ...
   fun:dl_open_worker
   ...
}
{
   dl_open_worker_reachable
   Memcheck:Leak
   match-leak-kinds: reachable
   ...
   fun:dl_open_worker
   ...
}
{
   start_thread_definite
   Memcheck:Leak
   match-leak-kinds: definite
   ...
   fun:start_thread
   fun:clone
}
{
   start_thread_indirect
   Memcheck:Leak
   match-leak-kinds: indirect
   ...
   fun:start_thread
   fun:clone
}
{
   start_thread_reachable
   Memcheck:Leak
   match-leak-kinds: reachable
   ...
   fun:start_thread
   fun:clone
}


# pthread errors
{
   pthread_initialize_param
   Memcheck:Param
   set_robust_list(head)
   fun:__pthread_initialize_minimal
   fun:(below main)
}
{
   pthread_initialize_cond
   Memcheck:Cond
   fun:__register_atfork
   fun:__libc_pthread_init
   fun:__pthread_initialize_minimal
   fun:(below main)
}


# std
{
   libc_cond
   Memcheck:Cond
   ...
   fun:_dl_init_paths
   fun:_dl_non_dynamic_init
   fun:__libc_init_first
   fun:(below main)
}
{
   libc_val8
   Memcheck:Value8
   ...
   fun:_dl_init_paths
   fun:_dl_non_dynamic_init
   fun:__libc_init_first
   fun:(below main)
}
{
   mallinfo_cond
   Memcheck:Cond
   fun:int_mallinfo
   fun:mallinfo
   ...
}
{
   mallinfo_value
   Memcheck:Value8
   fun:int_mallinfo
   fun:mallinfo
   ...
}
{
   int_free_cond
   Memcheck:Cond
   fun:_int_free
   ...
}
{
   string_len_cond
   Memcheck:Cond
   fun:strlen
   ...
}
{
   int_malloc_cond
   Memcheck:Cond
   fun:_int_malloc
   fun:malloc
   ...
}
{
   malloc_consolidate_malloc
   Memcheck:Cond
   fun:malloc_consolidate
   fun:_int_malloc
   ...
}
{
   malloc_consolidate_free
   Memcheck:Cond
   fun:malloc_consolidate
   fun:_int_free
   ...
}
{
   catch_cond
   Memcheck:Cond
   fun:__cxa_begin_catch
   ...
}
{
   popen
   Memcheck:Param
   set_robust_list(head)
   fun:__nptl_set_robust
   fun:__libc_fork
   fun:_IO_proc_open
   fun:popen
   ...
}
{
   exit
   Memcheck:Value8
   fun:__run_exit_handlers
   ...
   fun:exit
   ...
}
{
   sse42
   Memcheck:Cond
   fun:__strstr_sse42
   ...
}


# HDF5 memory errors
{
   HDF5_H5Eset_auto2
   Memcheck:Leak
   ...
   fun:H5_init_library
   fun:H5Eset_auto2
   ...
}


# PETsc memory errors
{
   PetscGetUserName/getpwuid
   Memcheck:Leak
   ...
   fun:getpwuid
   fun:PetscGetUserName
   ...
}
{
   PetscGetDate
   Memcheck:Leak
   ...
   fun:PetscGetDate
   fun:PetscErrorPrintfInitialize
   fun:PetscInitialize
   ...
}
{
   PetscInitialize/MPI_Init
   Memcheck:Leak
   ...
   fun:MPI_Init
   fun:PetscInitialize
   ...
}
{
   PetscMallocAlign
   Memcheck:Leak
   ...
   fun:malloc
   fun:PetscMallocAlign
   fun:PetscTrMallocDefault
   fun:PetscPushErrorHandler
   ...
}
{
   PetscOptionsInsert
   Memcheck:Leak
   ...
   fun:PetscOptionsInsert
   fun:PetscInitialize
   ...
}
{
   PetscMallocAlign
   Memcheck:Leak
   match-leak-kinds: reachable
   fun:memalign
   fun:PetscMallocAlign
   fun:PetscPushErrorHandler
   ...
}
{
   PetscMallocAlign2
   Memcheck:Leak
   match-leak-kinds: reachable
   fun:memalign
   fun:PetscMallocAlign
   fun:PetscTrMallocDefault
   fun:PetscPushErrorHandler
   ...
}


# libgfortran errors
{
   LibGFortranCond
    Memcheck:Cond
   ...
   obj:/usr/lib/libgfortran.so.3.0.0
   ...
}
{
   LibGFortranAddr
   Memcheck:Addr8
   ...
   obj:/usr/lib/libgfortran.so.3.0.0
   ...
}
{
   LibGFortranLeak
   Memcheck:Leak
   ...
   obj:/usr/lib/libgfortran.so.3.0.0
   ...
}


# Suppress OpenMP leaks
{
   omp_set_num_threads
   Memcheck:Leak
   fun:malloc
   ...
   fun:omp_set_num_threads
   ...
}
{
   GOMP_parallel
   Memcheck:Leak
   fun:malloc
   ...
   fun:GOMP_parallel
   ...
}


# Suppress all LibMesh errors
{
   LibMeshInit
   Memcheck:Leak
   ...
   fun:_ZN11LibMeshInitC1ERiRPPci
   ...
}


#### Supress Mac errors
{
   Mac/dyld_start/dyldbootstrap5start
   Memcheck:Leak
   ...
   fun:_ZN13dyldbootstrap5startEPK12macho_headeriPPKcl
   fun:_dyld_start
}
{
   Mac/throw/unwind
   Memcheck:Leak
   ...
   fun:unwind_phase2
   fun:_Unwind_RaiseException
   fun:__cxa_throw
   ...
}
{
   Mac/throw/unwind_Raise
   Memcheck:Leak
   ...
   fun:_Unwind_RaiseException
   fun:__cxa_throw
   ...
}
{
   Mac/allocate_exception
   Memcheck:Leak
   fun:malloc
   fun:__emutls_get_address
   fun:__cxa_get_globals
   fun:__cxa_allocate_exception
   ...
}
{
   Max/printf
   Memcheck:Leak
   fun:malloc
   fun:__Balloc_D2A
   ...
   fun:__dtoa
   fun:__vfprintf
   fun:__vfprintf
   fun:vfprintf_l
   fun:printf
   ...
}
{
   printfLeak
   Memcheck:Leak
   ...
   fun:malloc
   fun:__Balloc_D2A
   ...
   fun:__dtoa
   fun:__vfprintf
   fun:vsnprintf
   ...
}
{
   demangleLeak
   Memcheck:Leak
   ...
   fun:malloc
   fun:realloc
   ...
   fun:__cxa_demangle
   ...
}
{
   Mac/atexit
   Memcheck:Leak
   fun:malloc
   fun:atexit_register
   fun:__cxa_atexit
   ...
}
{
   Mac/initializer
   Memcheck:Leak
   ...
   fun:_libxpc_initializer
   fun:libSystem_initializer
   ...
}
{
   Mac/initializer2
   Memcheck:Leak
   ...
   fun:libSystem_initializer
   fun:_ZN16ImageLoaderMachO18doModInitFunctionsERKN11ImageLoader11LinkContextE
   ...
}
{
   Mac/printf
   Memcheck:Leak
   ...
   fun:vfprintf_l
   fun:printf
   ...
}
{
   Mac/lookupMethod
   Memcheck:Leak
   ...
   fun:lookUpMethod
   fun:objc_msgSend
   ...
}
{
   Mac\si_module_with_name
   Memcheck:Leak
   ...
   fun:si_module_with_name
   ...
}
{
   Mac\map_images
   Memcheck:Leak
   ...
   fun:map_images_nolock
   fun:map_images
   ...
}


